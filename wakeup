#!/bin/bash

cd /home/alegottu

readonly LOGIN_FILE=.last_login
readonly START_MINUTES=420 # 7:00 AM
readonly DEADLINE_MINUTES=605 # 10:05 AM
current_minutes=$(expr `date +%H` \* 60 + `date +%M`)

fail() {
	rm -f $LOGIN_FILE
	echo "$1; wsl --shutdown
if you don't want the bot to continue to run"
	# echo "pkill wakeup; pkill discord-account" | xclip -selection clipboard

	export PATH=/home/alegottu/.cargo/bin:$PATH # Let cargo be found by root
	cd no-write/discord-bot # Not a symbolic link so it can't be deleted
	./run send
	exit 0
}

success() {
	echo -n "Ride on time, streak: "
	echo $(expr $1 + 1) | tee $LOGIN_FILE
}

# Too early, do nothing
if [[ $current_minutes -lt $START_MINUTES ]]; then
	echo "Too early"; exit 0
fi

# No login file counts as empty streak
if [[ ! -f $LOGIN_FILE ]]; then
	if [[ $current_minutes -gt $DEADLINE_MINUTES ]]; then
		echo "Too late, streak not started"; exit 0
	else
		success 0
	fi
fi

last_login_day=$(date -r $LOGIN_FILE +%j)
streak=$(cat $LOGIN_FILE)
current_day=$(date +%j)
day_diff=$(expr \( $current_day - $last_login_day \) % 365)

# If we already logged in
if [[ $last_login_day -eq $current_day ]]; then
	echo "Already logged in"; exit 0
fi

# Absolute value of day difference, in case of last day of last year vs first day of new year
if [[ $day_diff -lt 0 ]]; then
	day_diff=$(expr $day_diff \* -1)
fi

# No more than a day gap between logins
if [[ $day_diff -gt 1 ]]; then
	readonly BREAK_FILE=.login_break
	if [[ -f $BREAK_FILE ]]; then
		break_days=$(cat $BREAK_FILE)
		day_sum=$(expr $last_login_day + $break_days)
		# TODO: with the above you can't create the break ahead of time after midnight, can maybe add exception for this

		# If the break wasn't created ahead of time on the last login date,
		# or we went past the planned amount of break days
		# NOTE: if you want to have a break for an undefined amount of days,
		# just delete the current login file before you log off
		if [[ $file_mod_day -ne $last_login_day ]] || [[ $day_sum -lt $(expr $current_day - 1) ]]; then
			fail "Break file was created too recently, or the break doesn't add up to the amount of days missed"
		fi

		rm -f $BREAK_FILE
		success $streak
	else
		fail "1+ day gap between now and your last login, but no break file"
	fi
else
	success $streak
fi
